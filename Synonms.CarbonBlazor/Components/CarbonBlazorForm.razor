@using Microsoft.AspNetCore.Components.Forms

@typeparam TModel

<EditForm class="cb-form" EditContext="@_editContext" OnValidSubmit="@OnValidSubmit" FormName="@FormName">
    @ChildContent
</EditForm>

@code {
    [Parameter]
    [EditorRequired]
    public TModel Model { get; set; } = default!;

    [Parameter]
    public string FormName { get; set; } = "RestEasyForm";
    
    [Parameter]
    [EditorRequired]
    public RenderFragment ChildContent { get; set; } = null!;

    [Parameter]
    public Action<ValidationMessageStore, TModel>? ValidateAction { get; set; }

    [Parameter]
    public EventCallback<TModel> ValidSubmitCallback { get; set; } = EventCallback<TModel>.Empty;

    private EditContext _editContext = null!;
    private ValidationMessageStore _validationMessageStore = null!;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        Console.WriteLine("CarbonBlazorForm - Creating edit context");
        
        _editContext = new EditContext(Model!);
        _validationMessageStore = new ValidationMessageStore(_editContext);
        _editContext.OnValidationRequested += OnValidationRequested;
    }

    private void OnValidationRequested(object? o, ValidationRequestedEventArgs? args)
    {
        Console.WriteLine("CarbonBlazorForm - OnValidationRequested");
        
        _validationMessageStore.Clear();
        
        ValidateAction?.Invoke(_validationMessageStore, Model);
        
        _editContext.NotifyValidationStateChanged();
    }
    
    private async Task OnValidSubmit()
    {
        Console.WriteLine("CarbonBlazorForm - OnValidSubmit");

        if (ValidSubmitCallback.HasDelegate)
        {
            await ValidSubmitCallback.InvokeAsync(Model);
        }
    }
    
    public void Dispose()
    {
        _editContext.OnValidationRequested -= OnValidationRequested;
    }
}

